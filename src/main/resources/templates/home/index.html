<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="en">
<!--/*@thymesVar id="projects" type="java.util.List"*/-->
<!--/*@thymesVar id="project" type="ru.javaprojects.projector.projects.to.ProjectPreviewTo"*/-->

<th:block th:replace="~{fragments/main::page(title=#{home},appMain=~{::appMain}, ownScript=~{::ownScript}, ownCss='project.css')}">
    <appMain>
        <div class="px-xl-5">
            <button type="button" class="with-popover btn btn-outline-success float-end" data-bs-toggle="popover" data-bs-trigger="manual"
                    th:data-bs-title="'<a type=&quot;button&quot; class=&quot;btn-close ms-2 float-end tiny&quot;></a><div>'+ #{info.only-for-auth-users}+ '</div>'"
                    th:data-bs-content="'<div class=&quot;text-center&quot;><a href=&quot;/login&quot; type=&quot;button&quot; class=&quot;btn btn-sm btn-warning px-3&quot;>' + #{login} + '</a></div>'"
                    data-bs-html="true" onclick="showAddProjectPage($(this))">
                <i class="fa-solid fa-plus me-1"></i><span th:text="#{project.add-new}"></span>
            </button>
            <ul class="nav nav-underline">
                <li class="nav-item">
                    <button class="nav-link secondary-nav-link pt-0" type="button" role="tab" aria-controls="nav-changes"
                            aria-selected="false" onclick="showFresh()" id="freshNav">Fresh</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link secondary-nav-link pt-0" type="button" role="tab" aria-controls="nav-general"
                            aria-selected="true" id="popularNav" onclick="showPopular()">Popular</button>
                </li>
                <li sec:authorize="isAuthenticated()" class="nav-item">
                    <button class="nav-link secondary-nav-link pt-0" type="button" role="tab" aria-controls="nav-changes"
                            aria-selected="false" onclick="showMy()" id="myNav">My projects</button>
                </li>
            </ul>
        </div>

        <div th:if="${projects.isEmpty()}" class="px-xl-5 mt-3">
            <h5 class="alert alert-warning" th:text="#{project.no-projects-found}">No projects found.</h5>
        </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 mt-3 px-xl-5" id="projectsArea">
            <div th:each="project : ${projects}" class="col mb-4">
                <div class="card h-100 project-card rounded-3">
                    <div class="ratio" style="--bs-aspect-ratio: 50%;">
                        <img th:src="@{${project.preview.getSrc()}}" class="card-img-top rounded-top-3"  style="object-fit: cover"/>
                    </div>
                    <div th:title="#{architecture}">
                        <img th:src="@{${project.architecture.logo != null ? ('/' + project.architecture.logo.fileLink) : ''}}"
                             class="float-end bg-light-subtle border border-light-subtle rounded-circle p-1"
                             data-bs-toggle="tooltip" th:title="${project.architecture.name}"
                             onmouseenter="$(this).removeClass('p-1')"
                             onmouseleave="$(this).addClass('p-1')"
                             width="40" height="40"
                             style="margin-top: -20px; margin-right: 15px; z-index: 2; position: relative;
                             box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2), 0 1px 2px 0 rgba(0, 0, 0, 0.19);"/>
                    </div>

                    <div class="card-body d-flex flex-column pb-0" style="margin-top: -35px;">
                            <div class="d-flex">
                                <div class="pt-3 pb-2 ps-3" style="position: relative; z-index: 2; margin-left: -16px;">
                                    <a th:href="@{'/profile/' + ${project.author.id} + '/view'}" class="text-decoration-none link-body-emphasis">
                                        <img class="rounded-circle border" th:src="@{${project.author.avatar != null ?
                                        project.author.avatar.getSrc() : '/images/no-avatar.svg'}}" width="40" height="40"
                                             style="object-fit: cover" th:title="${project.author.name}"
                                             onmouseenter="$(this).addClass('opacity-75')" onmouseleave="$(this).removeClass('opacity-75')" />
                                    </a>
                                </div>
                                <div class="pt-3 pb-2 ps-2 pe-3" style="position: relative; z-index: 2;">
                                    <a th:href="@{'/profile/' + ${project.author.id} + '/view'}" class="text-decoration-none link-body-emphasis">
                                        <span class="h6" th:text="${project.author.name}" >Author name</span>
                                    </a>
                                    <div class="tiny text-secondary-emphasis" style="margin-top: -3px;"
                                         th:text="${#temporals.format(project.created, 'dd.MM.yyyy HH:mm')}">Created</div>
                                </div>
                            </div>
                        <h5 class="card-title" th:text="${project.name}">Title</h5>
                        <span class="card-text" th:text="${project.annotation}">Annotation</span>
                        <div class="row mt-auto pt-3 pb-1" style="position: relative; z-index: 2;">
                            <div class="col-8">
                                <a th:href="@{'/projects/' + ${project.id} + '/view#comments'}" type="button" th:title="#{comment.comments}"
                                   class="btn-link text-decoration-none link-info">
                                    <i class="fa-regular fa-comments"></i>
                                    <span class="text-secondary-emphasis small" th:text="${project.commentsCount}"></span>
                                </a>
                                <a type="button" title="Like" th:onclick="|likeProject(this, '${project.id}')|"
                                   class="with-popover btn-link link-danger text-decoration-none ms-3"
                                   data-bs-toggle="popover" data-bs-trigger="manual"
                                   th:data-bs-title="'<a type=&quot;button&quot; class=&quot;btn-close ms-2 float-end tiny&quot;></a><div>'+ #{info.only-for-auth-users}+ '</div>'"
                                  th:data-bs-content="'<div class=&quot;text-center&quot;><a href=&quot;/login&quot; type=&quot;button&quot; class=&quot;btn btn-sm btn-warning px-3&quot;>' + #{login} + '</a></div>'" data-bs-html="true">
                                    <i class="fa-heart" th:title="#{like}"
                                       th:classappend="${authUser == null || !project.likesUserIds.contains(authUser.id) ?
                                            'fa-regular' : 'fa-solid'}"></i>
                                    <span class="text-secondary-emphasis small" th:title="#{like}" th:text="${project.likesUserIds.size()}"></span>
                                </a>
                                <a type="button"
                                        class="btn-link link-primary text-decoration-none ms-3"
                                        th:title="#{project.share}" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa-solid fa-share"></i>
                                </a>
                                <ul class="dropdown-menu">
                                    <li><button type="button" class="dropdown-item" th:onclick="|copyLink('${project.id}')|">
                                        <i class="fa-solid fa-link fa-fw"></i><span class="ms-2" th:text="#{info.share.copy-link}"></span>
                                    </button></li>
                                    <li><button type="button" class="dropdown-item" onclick="shareOnVk($(this))"
                                                th:data-id="${project.id}" th:data-name="${project.name}">
                                           <i class="fa-brands fa-vk fa-fw"></i><span class="ms-2" th:text="#{info.share.vk}"></span>
                                    </button></li>
                                    <li><button type="button" class="dropdown-item" onclick="shareOnTelegram($(this))"
                                                th:data-id="${project.id}" th:data-name="${project.name}">
                                        <i class="fa-brands fa-telegram fa-fw"></i><span class="ms-2" th:text="#{info.share.telegram}"></span>
                                    </button></li>
                                    <li><button type="button" class="dropdown-item" onclick="shareOnWhatsApp($(this))"
                                                th:data-id="${project.id}" th:data-name="${project.name}">
                                        <i class="fa-brands fa-whatsapp fa-fw"></i><span class="ms-2" th:text="#{info.share.whatsapp}"></span>
                                    </button></li>
                                </ul>
                            </div>
                            <div class="col-4 text-end">
                                <i class="fa-regular fa-eye" style="color: #a1a0a0;"></i>
                                <span class="text-secondary-emphasis small" th:text="${project.views}"></span>
                            </div>
                        </div>
                        <a th:href="@{'/projects/' + ${project.id} + '/view'}" class="stretched-link"></a>
                    </div>
                    <div class="card-footer" style="height: 78px; position: relative; z-index: 1">
                        <div class="text-truncate-container">
                            <a th:each="technology : ${project.technologies}" th:href="@{${technology.url}}"
                               type="button" target="_blank" class="me-1 mb-1" style="text-decoration: none"
                               th:title="${technology.name}">
                                <img th:src="@{${technology.logo != null ? ('/' + technology.logo.fileLink) : ''}}"
                                     width="24" height="24" onmouseenter="$(this).addClass('opacity-75')"
                                     onmouseleave="$(this).removeClass('opacity-75')" />
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${byAuthor == null}" class="text-center mb-3" id="loading">
            <div class="spinner-border">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </appMain>

    <ownScript>
        <script>
            sessionStorage.removeItem('prevUrl');
            sessionStorage.removeItem('projectDataPagePrevUrl');
        </script>
        <script src="/js/common.js?v=1"></script>
        <script src="/js/index.js?v=1"></script>
        <script src="/js/share-project-button.js?v=1"></script>

        <script>
            let currentNav = null;
            let urlParams = new URLSearchParams(window.location.search);

            if (urlParams.has('popular')) {
                currentNav = 'popularNav';
            } else if (authUser != null && urlParams.has('by-author') && urlParams.get('by-author') ==  authUser.user.id) {
                currentNav = 'myNav';
            } else if (!urlParams.has('by-author')) {
                currentNav = 'freshNav';
            }

            if (currentNav != null) {
                $(`#${currentNav}`).addClass('active');
            }


            function showPopular() {
                if (currentNav !== 'popularNav') {
                    window.location.href = '?popular';
                }
            }

            function showFresh() {
                if (currentNav !== 'freshNav') {
                    window.location.href = '/';
                }
            }

            function showMy() {
                if (currentNav !== 'myNav') {
                    window.location.href = `?by-author=${authUser.user.id}`;
                }
            }

            let currentPage = 0;
            let loading = false;
            const projectsArea = $('#projectsArea');
            const loadingDiv = $('#loading')[0];

            const observer = new IntersectionObserver(async (entries) => {
                if (entries[0].isIntersecting && !loading) {
                    loading = true;
                    currentPage++;
                    getProjects();
                }
            }, { threshold: 0.25 });
            observer.observe(loadingDiv);

            function getProjects() {
                let pathVariable = currentNav != null && currentNav === 'popularNav' ? 'popular' : 'fresh';
                $.ajax({
                    url: `/projects/${pathVariable}`,
                    data: { page: currentPage, size: 9 }
                }).done(projectsPage => {
                    if (projectsPage.content.length !== 0) {
                        projectsPage.content.forEach(project => {
                            let col = $('<div></div>').addClass('col mb-4');
                            col.append(generateProjectCard(project));
                            projectsArea.append(col);
                        });
                    } else {
                        observer.disconnect();
                        loadingDiv.remove();
                    }
                    loading = false;
                }).fail(function(data) {
                    handleError(data, getMessage('project.failed-to-get-projects'));
                    loading = false;
                });
            }

            function generateProjectCard(project) {
                let card = $('<div></div>').addClass('card h-100 project-card rounded-3');
                let previewDiv = $('<div></div>').addClass('ratio').css('--bs-aspect-ratio', '50%');
                let preview = $('<img>').addClass('card-img-top rounded-top-3').css('object-fit', 'cover')
                    .attr('src', `/${project.preview.fileLink}`);
                previewDiv.append(preview);
                card.append(previewDiv);
                let architectureDiv = $('<div></div>').attr('title', getMessage('architecture'));
                let architectureImage = $('<img>').addClass('float-end bg-light-subtle border border-light-subtle rounded-circle p-1')
                    .attr('src', `/${project.architecture.logo.fileLink}`)
                    .attr('data-bs-toggle', 'tooltip').attr('title', project.architecture.name)
                    .attr('width', '40').attr('height', '40').css('margin-top', '-20px').css('margin-right', '15px')
                    .css('z-index', '2').css('position', 'relative')
                    .css('box-shadow', '0 1px 2px 0 rgba(0, 0, 0, 0.2), 0 1px 2px 0 rgba(0, 0, 0, 0.19)')
                    .on('mouseenter', function () {
                        $(this).removeClass('p-1');
                    })
                    .on('mouseleave', function () {
                        $(this).addClass('p-1');
                    });
                architectureDiv.append(architectureImage);
                card.append(architectureDiv);

                let cardBody = $('<div></div>').addClass('card-body d-flex flex-column pb-0').css('margin-top', '-35px');
                let dFlexDiv = $('<div></div>').addClass('d-flex');
                let avatarDiv = $('<div></div>').addClass('pt-3 pb-2 ps-3').css('position', 'relative').css('z-index', '2')
                    .css('margin-left', '-16px');
                let avatarLink = $('<a></a>').addClass('text-decoration-none link-body-emphasis')
                    .attr('href', `/profile/${project.author.id}/view`).attr('title', project.author.name);
                let avatar = $('<img>').addClass('rounded-circle border')
                    .attr('src', getAvatarLink(project.author.avatar))
                    .attr('width', '40').attr('height', '40').css('object-fit', 'cover')
                    .on('mouseenter', function () {
                        $(this).addClass('opacity-75');
                    })
                    .on('mouseleave', function () {
                        $(this).removeClass('opacity-75');
                    });
                avatarLink.append(avatar);
                avatarDiv.append(avatarLink);
                dFlexDiv.append(avatarDiv);
                let authorNameAndCreatedDiv = $('<div></div>').addClass('pt-3 pb-2 px-3').css('position', 'relative')
                    .css('z-index', '2').css('margin-left', '-8px');
                let authorName = $('<span></span>').addClass('h6').text(project.author.name);
                let authorNameLink = $('<a></a>').addClass('text-decoration-none link-body-emphasis')
                    .attr('href', `/profile/${project.author.id}/view`);
                authorNameLink.append(authorName);
                authorNameAndCreatedDiv.append(authorNameLink);
                let createdDiv = $('<div></div>').addClass('tiny text-secondary-emphasis').css('margin-top', '-3px')
                    .text(formatDateTime(project.created));
                authorNameAndCreatedDiv.append(createdDiv);
                dFlexDiv.append(authorNameAndCreatedDiv);
                cardBody.append(dFlexDiv);

                let name = $('<h5></h5>').addClass('card-title').text(project.name).attr('id', `${project.id}-name-elem`);
                cardBody.append(name);
                if (!project.visible) {
                    let invisibleSymbol = $('<i></i>').addClass('fa-solid fa-eye-slash text-warning tiny float-end')
                        .attr('title', getMessage('project.invisible-to-users')).css('position', 'relative')
                        .css('z-index', '2');
                    name.append(invisibleSymbol);
                }

                let annotation = $('<span></span>').addClass('card-text').text(project.annotation);
                cardBody.append(annotation);

                let likesCommentsShareViewsRow = $('<div></div>').addClass('row mt-auto pt-3 pb-1').css('position', 'relative')
                    .css('z-index', '2');
                let likesCommentsShareCol = $('<div></div>').addClass('col-8');
                likesCommentsShareViewsRow.append(likesCommentsShareCol);
                let commentsBtn = $('<a></a>').addClass('btn-link text-decoration-none link-info').attr('type', 'button')
                    .attr('title', getMessage('comment.comments')).attr('href', `/projects/${project.id}/view#comments`);
                let commentsSymbol = $('<i></i>').addClass('fa-regular fa-comments');
                let commentsCounter = $('<span></span>').addClass('ms-1 text-secondary-emphasis small').text(project.commentsCount);
                commentsBtn.append(commentsSymbol);
                commentsBtn.append(commentsCounter);
                likesCommentsShareCol.append(commentsBtn);
                let likeBtn = $('<a></a>').addClass('with-popover btn-link link-danger text-decoration-none ms-3')
                    .attr('type', 'button').attr('data-bs-toggle', 'popover')
                    .attr('data-bs-trigger', 'manual')
                    .attr('data-bs-title', `"<a type='button' class='btn-close ms-2 float-end tiny'></a><div>${getMessage('info.only-for-auth-users')}</div>"`)
                    .attr('data-bs-content', `"<div class='text-center'><a href='/login' type='button' class='btn btn-sm btn-warning px-3'>${getMessage('login')}</a></div>"`)
                    .attr('data-bs-html', 'true')
                    .on('click', function () {
                        likeProject($(this), project.id);
                    });
                let likeSymbol = $('<i></i>').addClass('fa-heart')
                    .addClass(`${authUser === null || !project.likesUserIds.includes(authUser.user.id) ? 'fa-regular' : 'fa-solid'}`)
                    .attr('title', getMessage('like'));
                let likeCounter = $('<span></span>').addClass('ms-1 text-secondary-emphasis small')
                    .attr('title', getMessage('like')).text(project.likesUserIds.length);
                likeBtn.append(likeSymbol);
                likeBtn.append(likeCounter);
                likesCommentsShareCol.append(likeBtn);
                let shareBtn = $('<a></a>').attr('type', 'button').addClass('btn-link link-primary text-decoration-none ms-3')
                    .attr('title', getMessage('project.share')).attr('data-bs-toggle', 'dropdown');
                let shareSymbol = $('<i></i>').addClass('fa-solid fa-share');
                shareBtn.append(shareSymbol);
                let shareDropDownMenu = $('<ul></ul>').addClass('dropdown-menu');
                let copyLinkItem = $('<li></li>');
                let copyLinkBtn = $('<button></button>').attr('type', 'button').addClass('dropdown-item')
                    .html(`<i class="fa-solid fa-link fa-fw me-2"></i>${getMessage('project.copy-link')}`)
                    .on('click', () => copyLink(project.id));
                copyLinkItem.append(copyLinkBtn);
                shareDropDownMenu.append(copyLinkItem);
                let shareOnVkItem = $('<li></li>');
                let shareOnVkBtn = $('<button></button>').attr('type', 'button').addClass('dropdown-item')
                    .attr('data-id', project.id).attr('data-name', project.name)
                    .html(`<i class="fa-brands fa-vk fa-fw me-2"></i>${getMessage('project.share-on-vk')}`)
                    .on('click', function () {shareOnVk($(this))});
                shareOnVkItem.append(shareOnVkBtn);
                shareDropDownMenu.append(shareOnVkItem);
                let shareOnTelegramItem = $('<li></li>');
                let shareOnTelegramBtn = $('<button></button>').attr('type', 'button').addClass('dropdown-item')
                    .attr('data-id', project.id).attr('data-name', project.name)
                    .html(`<i class="fa-brands fa-telegram fa-fw me-2"></i>${getMessage('project.share-on-telegram')}`)
                    .on('click', function () {shareOnTelegram($(this))});
                shareOnTelegramItem.append(shareOnTelegramBtn);
                shareDropDownMenu.append(shareOnTelegramItem);
                let shareOnWhatsAppItem = $('<li></li>');
                let shareOnWhatsAppBtn = $('<button></button>').attr('type', 'button').addClass('dropdown-item')
                    .attr('data-id', project.id).attr('data-name', project.name)
                    .html(`<i class="fa-brands fa-whatsapp fa-fw me-2"></i>${getMessage('project.share-on-whatsapp')}`)
                    .on('click', function () {shareOnWhatsApp($(this))});
                shareOnWhatsAppItem.append(shareOnWhatsAppBtn);
                shareDropDownMenu.append(shareOnWhatsAppItem);
                likesCommentsShareCol.append(shareBtn);
                likesCommentsShareCol.append(shareDropDownMenu);

                let viewsCol = $('<div></div>').addClass('col-4 text-end');
                let viewsSymbol = $('<i></i>').addClass('fa-regular fa-eye').css('color', '#a1a0a0');
                let viewsCounter = $('<span></span>').addClass('ms-1 text-secondary-emphasis small').text(project.views);
                viewsCol.append(viewsSymbol);
                viewsCol.append(viewsCounter);
                likesCommentsShareViewsRow.append(viewsCol);
                cardBody.append(likesCommentsShareViewsRow);

                let projectLink = $('<a></a>').addClass('stretched-link').attr('href', `/projects/${project.id}/view`);
                cardBody.append(projectLink);

                card.append(cardBody);

                let footer = $('<div></div>').addClass('card-footer').css('position', 'relative').css('z-index', '1');
                let technologiesDiv = $('<div></div>');
                footer.append(technologiesDiv);
                project.technologies.forEach(technology => {
                    let technologyLink = $('<a></a>').attr('type', 'button').attr('target', '_blank')
                        .attr('title', technology.name).attr('href', technology.url).addClass('me-1 mb-1')
                        .css('text-decoration', 'none');
                    let technologyLogo = $('<img>').attr('src', `/${technology.logo.fileLink}`).attr('width', 24)
                        .attr('height', 24)
                        .on('mouseenter', function () {
                            $(this).addClass('opacity-75');
                        })
                        .on('mouseleave', function () {
                            $(this).removeClass('opacity-75');
                        });
                    technologyLink.append(technologyLogo);
                    technologiesDiv.append(technologyLink);
                });

                card.append(footer);
                return card;
            }

            function getAvatarLink(avatar) {
                return avatar != null ? (avatar.fileLink.startsWith('https://') ? avatar.fileLink : `/${avatar.fileLink}`) : '/images/no-avatar.svg';
            }

            function formatDateTime(dateTime) {
                let dateAndTime = dateTime.split('T');
                let dateParts =  dateAndTime[0].split('-');
                let formattedDate = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;
                let formattedTime = dateAndTime[1].substring(0, dateAndTime[1].lastIndexOf(':'));
                return `${formattedDate} ${formattedTime}`;
            }


        </script>
    </ownScript>
</th:block>
