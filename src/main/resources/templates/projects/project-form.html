<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<!--/*@thymesVar id="projectTo" type="ru.javaprojects.projector.projects.ProjectTo"*/-->

<th:block th:replace="~{fragments/main::page(title='Projects',appMain=~{::appMain}, ownScript=~{::ownScript}, activeMenuItem=${ {'projects', 'management'} })}">
    <appMain>
        <div class="bg-info-subtle px-2 rounded-2 mb-10px border border-secondary-subtle py-0">
            <div class="row align-items-center" style="height: 46px">
                <div class="col text-start text-truncate">
                    <span class="h3 text-secondary font-weight-bold"
                          th:utext="${'<i class=''fa-solid fa-layer-group me-2''></i>Projects / ' + (projectTo.isNew() ? 'Create' : 'Edit')}">Projects / Create Edit</span>
                </div>
            </div>
        </div>

        <!-- Create/Edit project card -->
        <div class="row d-flex justify-content-center align-items-center">
            <div class="col-12 col-xxl-10">
                <div class="card shadow">
                    <div class="card-header">
                        <h3 class="text-center" th:text="${projectTo.isNew()} ? 'New project' : 'Edit: ' + ${projectTo.name}">Create/Edit project</h3>
                    </div>
                    <form th:action="@{/projects}" method="post" th:object="${projectTo}" enctype="multipart/form-data">
                        <div class="card-body text-start">
                            <input type="hidden" th:field="*{id}">
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text project-card-label">Name</span>
                                    <input type="text" id="nameInput" th:field="*{name}"
                                           th:class="${#fields.hasErrors('name')} ? 'form-control is-invalid' : 'form-control'"
                                           required placeholder="Name" />
                                </div>
                                <span th:if="${#fields.hasErrors('name')}">
                                    <ul>
                                        <li class="text-danger text-start" th:each="err : ${#fields.errors('name')}"
                                            th:text="${err}"/>
                                    </ul>
                                </span>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text project-card-label">Architecture</span>
                                        <select class="form-control selectpicker border" data-style="btn-white"
                                                name="architecture" title="Architecture" required>
                                            <option th:each="architecture : ${architectures}"
                                                    th:value="${architecture.id}"
                                                    th:text="${architecture.name}"
                                                    th:selected="${projectTo.architecture != null && projectTo.architecture.id == architecture.id}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text project-card-label">Dev start date</span>
                                        <input type="date" id="startDate" name="startDate" th:value="${projectTo.startDate}"
                                               class="form-control date-input" th:classappend="${projectTo.startDate == null ? 'text-muted' : ''}" required />
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text project-card-label">Dev end date</span>
                                        <input type="date" name="endDate" th:value="${projectTo.endDate}"
                                               class="form-control date-input" th:classappend="${projectTo.endDate == null ? 'text-muted' : ''}" required />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text project-card-label">Priority</span>
                                        <select class="form-control selectpicker border" data-style="btn-white"
                                                th:field="*{priority}" title="Priority" required>
                                            <option th:each="priority : ${priorities}"
                                                    th:value="${priority.name}"
                                                    th:text="${priority}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text project-card-label">Visibility</span>
                                        <span class="form-control">
                                            <div class="form-switch">
                                                <input type="checkbox" role="switch" th:field="*{enabled}" class="form-check-input me-1"
                                                       style="cursor: pointer;" id="visibilityCheckbox" />
                                                <span th:text="${projectTo.enabled ? 'Visible to users' : 'Not visible to users'}" id="visibilityCheckboxDesc"></span>
                                            </div>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <div th:hidden="${logoFile == null}" class="input-group" id="logoFilePreviewDiv">
                                        <span class="input-group-text project-card-label">Logo file</span>
                                        <div class="form-control py-1 text-start">
                                            <img th:src="@{${logoFile != null ? ('/' + logoFile.fileLink) : ''}}"
                                                 width="24" height="24" id="logoFilePreview"/>
                                            <span th:text="${logoFile?.fileName}" id="logoFileName">File name</span>
                                            <a tabindex="0" type="button" class="float-end text-danger" title="Delete"
                                               onclick="deleteLogoFile()">
                                                <i class="fa-solid fa-xmark"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div id="logoFileInputDiv">
                                        <div th:if="${logoFile == null}" class="input-group custom-file-button">
                                            <label class="input-group-text bg-light project-card-label">Logo file</label>
                                            <input type="file" accept="image/*" th:field="*{logoFile}" class="form-control text-muted"
                                                   id="logoFileInput" required onchange="previewLogoFile()"/>
                                        </div>
                                        <span th:if="${#fields.hasErrors('logoFile')}">
                                            <ul>
                                                <li class="text-danger text-start"
                                                    th:each="err : ${#fields.errors('logoFile')}" th:text="${err}"/>
                                            </ul>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <div th:hidden="${dockerComposeFile == null}" class="input-group" id="dockerFilePreviewDiv">
                                        <span class="input-group-text project-card-label">Docker file</span>
                                        <div class="form-control py-1 text-start">
                                            <a th:href="@{${'/' + dockerComposeFile?.fileLink}}" id="dockerComposeFileRef"
                                               th:utext="'<i class=&quot;text-primary me-1 fa-brands fa-docker&quot;></i>' + ${dockerComposeFile?.fileName}"
                                               target="_blank" title="Download file">File name</a>

                                            <a tabindex="0" type="button" class="float-end text-danger" title="Delete"
                                               onclick="deleteDockerFile()">
                                                <i class="fa-solid fa-xmark"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div id="dockerFileInputDiv">
                                        <div th:if="${dockerComposeFile == null}" class="input-group custom-file-button">
                                            <label class="input-group-text bg-light project-card-label">Docker file</label>
                                            <input type="file" accept=".yaml,.yml" th:field="*{dockerComposeFile}" class="form-control text-muted"
                                                   id="dockerFileInput" onchange="previewDockerFile()"/>
                                        </div>
                                        <span th:if="${#fields.hasErrors('dockerComposeFile')}">
                                            <ul>
                                                <li class="text-danger text-start"
                                                    th:each="err : ${#fields.errors('dockerComposeFile')}" th:text="${err}"/>
                                            </ul>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <div class="col-11">
                                    <div class="input-group">
                                        <span class="input-group-text project-card-label">Deployment URL</span>
                                        <input type="url" id="deploymentUrlInput" th:field="*{deploymentUrl}" class="url"
                                               th:classappend="${#fields.hasErrors('deploymentUrl')} ? 'form-control is-invalid' : 'form-control'"
                                               placeholder="Deployment URL" />
                                    </div>
                                    <span th:if="${#fields.hasErrors('deploymentUrl')}">
                                        <ul>
                                            <li class="text-danger text-start" th:each="err : ${#fields.errors('deploymentUrl')}"
                                                th:text="${err}"/>
                                        </ul>
                                    </span>
                                </div>
                                <div class="col-1">
                                    <a th:hidden="${projectTo.deploymentUrl == null}" th:href="${projectTo.deploymentUrl}" class="url-check"
                                       title="Check deployment URL" id="deploymentUrlCheck" target="_blank"><i class="fa-solid fa-up-right-from-square ms-1"></i></a>
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <div class="col-11">
                                    <div class="input-group">
                                        <span class="input-group-text project-card-label">Open API URL</span>
                                        <input type="url" id="openApiUrlInput" th:field="*{openApiUrl}" class="url"
                                               th:classappend="${#fields.hasErrors('openApiUrl')} ? 'form-control is-invalid' : 'form-control'"
                                               placeholder="Open API URL" />
                                    </div>
                                    <span th:if="${#fields.hasErrors('openApiUrl')}">
                                        <ul>
                                            <li class="text-danger text-start" th:each="err : ${#fields.errors('openApiUrl')}"
                                                th:text="${err}"/>
                                        </ul>
                                    </span>
                                </div>
                                <div class="col-1">
                                    <a th:hidden="${projectTo.openApiUrl == null}" th:href="${projectTo.openApiUrl}" class="url-check"
                                       title="Check Open API URL" id="openApiUrlCheck" target="_blank"><i class="fa-solid fa-up-right-from-square ms-1"></i></a>
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <div class="col-11">
                                    <div class="input-group">
                                        <span class="input-group-text project-card-label">Backend src URL</span>
                                        <input type="url" id="backendSrcUrlInput" th:field="*{backendSrcUrl}" class="url"
                                               th:classappend="${#fields.hasErrors('backendSrcUrl')} ? 'form-control is-invalid' : 'form-control'"
                                               required placeholder="Backend src URL" />
                                    </div>
                                    <span th:if="${#fields.hasErrors('backendSrcUrl')}">
                                        <ul>
                                            <li class="text-danger text-start" th:each="err : ${#fields.errors('backendSrcUrl')}"
                                                th:text="${err}"/>
                                        </ul>
                                    </span>
                                </div>
                                <div class="col-1">
                                    <a th:hidden="${projectTo.backendSrcUrl == null}" th:href="${projectTo.backendSrcUrl}" class="url-check"
                                       title="Check backend src URL" id="backendSrcUrlCheck" target="_blank"><i class="fa-solid fa-up-right-from-square ms-1"></i></a>
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <div class="col-11">
                                    <div class="input-group">
                                        <span class="input-group-text project-card-label">Frontend src URL</span>
                                        <input type="url" id="frontendSrcUrlInput" th:field="*{frontendSrcUrl}" class="url"
                                               th:classappend="${#fields.hasErrors('frontendSrcUrl')} ? 'form-control is-invalid' : 'form-control'"
                                               placeholder="Frontend src URL" />
                                    </div>
                                    <span th:if="${#fields.hasErrors('frontendSrcUrl')}">
                                        <ul>
                                            <li class="text-danger text-start" th:each="err : ${#fields.errors('frontendSrcUrl')}"
                                                th:text="${err}"/>
                                        </ul>
                                    </span>
                                </div>
                                <div class="col-1">
                                    <a th:hidden="${projectTo.frontendSrcUrl == null}" th:href="${projectTo.frontendSrcUrl}" class="url-check"
                                       title="Check frontend src URL" id="frontendSrcUrlCheck" target="_blank"><i class="fa-solid fa-up-right-from-square ms-1"></i></a>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <div th:hidden="${cardImageFile == null}" class="input-group" id="cardImageFilePreviewDiv">
                                        <span class="input-group-text project-card-label">Card image file</span>
                                        <div class="form-control py-1 text-start">
                                            <img th:src="@{${cardImageFile != null ? ('/' + cardImageFile.fileLink) : ''}}"
                                                 width="42" height="24" id="cardImageFilePreview"/>
                                            <span th:text="${cardImageFile?.fileName}" id="cardImageFileName">File name</span>
                                            <a tabindex="0" type="button" class="float-end text-danger" title="Delete"
                                               onclick="deleteCardImageFile()">
                                                <i class="fa-solid fa-xmark"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div id="cardImageFileInputDiv">
                                        <div th:if="${cardImageFile == null}" class="input-group custom-file-button">
                                            <label class="input-group-text bg-light project-card-label">Card image file</label>
                                            <input type="file" accept="image/*" th:field="*{cardImageFile}" class="form-control text-muted"
                                                   id="cardImageFileInput" required onchange="previewCardImageFile()"/>
                                        </div>
                                        <span th:if="${#fields.hasErrors('cardImageFile')}">
                                            <ul>
                                                <li class="text-danger text-start"
                                                    th:each="err : ${#fields.errors('cardImageFile')}" th:text="${err}"/>
                                            </ul>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text project-card-label">Technologies</span>
                                        <select class="form-control selectpicker border" data-style="btn-white" id="technologiesSelector"
                                                name="technologiesIds" multiple data-selected-text-format="count > 3" title="Technologies" required>
                                            <option th:each="technology : ${technologies}"
                                                    th:value="${technology.id}"
                                                    th:text="${technology.name}"
                                                    th:data-name="${technology.name}"
                                                    th:data-filelink="${technology.logoFile.fileLink}"
                                                    th:selected="${projectTo.technologiesIds != null && projectTo.technologiesIds.contains(technology.id)}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-4 mb-3">
                                    <div class="border rounded-2 px-3 pb-3 text-center h-100">
                                        <div class="text-start text-muted tiny">
                                            Card image
                                        </div>
                                        <img th:src="@{${cardImageFile != null ? ('/' + cardImageFile.fileLink) : ''}}"
                                             height="150px" class="rounded-2 mt-2" id="cardImageFileLargePreview"/>
                                    </div>
                                </div>
                                <div class="col-lg-8 mb-3">
                                    <div class="border rounded-2 px-3 pb-3 h-100">
                                        <div class="text-start text-muted tiny">
                                            Technologies
                                        </div>
                                        <div id="technologiesPreviewDiv">
                                            <span th:each="technology : ${technologies}" th:if="${projectTo.technologiesIds?.contains(technology.id)}" class="badge text-bg-light me-2 mt-2" th:id="${'techSpan-' + technology.id}">
                                                <img th:src="@{${technology.logoFile != null ? ('/' + technology.logoFile.fileLink) : ''}}"
                                                     width="32" height="32" th:text="${technology.name}" class="align-bottom"/>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="form-floating">
                                    <small class="position-absolute text-muted " style="right: 30px;" id="characterCounter"
                                           th:text="*{(128 - (shortDescription == null ? 0 : shortDescription.length())) + ' characters left'}">Characters left</small>
                                    <textarea id="shortDescriptionInput" th:field="*{shortDescription}"
                                              th:class="${#fields.hasErrors('shortDescription')} ? 'form-control lh-base is-invalid' : 'form-control lh-base'"
                                              placeholder="Short description" style="height: 90px; white-space: pre-wrap;"
                                              maxlength="128" required></textarea>
                                    <label for="shortDescriptionInput" class="text-muted">Short description</label>
                                </div>
                                <span th:if="${#fields.hasErrors('shortDescription')}">
                                    <ul>
                                        <li class="text-danger text-start" th:each="err : ${#fields.errors('shortDescription')}"
                                            th:text="${err}"/>
                                    </ul>
                                </span>
                            </div>

                            <!-- Description block -->

                            <div class="fw-bold text-info-emphasis mb-2">Description elements</div>
                            <div id="elementsBlock">
                                <div th:each="element, itemStat : ${projectTo.descriptionElementTos}"
                                     th:id="${'elementContainer-' + itemStat.index}" class="element-container mb-1">
                                    <input type="hidden" th:id="${'elementId-' + itemStat.index}"
                                           th:name="${'descriptionElementTos[' + itemStat.index + '].id'}"
                                           th:value="${element.id}"/>
                                    <input type="hidden" th:id="${'elementType-' + itemStat.index}"
                                           th:name="${'descriptionElementTos[' + itemStat.index + '].type'}"
                                           th:value="${element.type.name}"/>
                                    <input type="hidden" th:id="${'elementIndex-' + itemStat.index}"
                                           th:name="${'descriptionElementTos[' + itemStat.index + '].index'}"
                                           th:value="${element.index}"/>
                                    <input type="hidden" th:id="${'elementFileName-' + itemStat.index}"
                                           th:name="${'descriptionElementTos[' + itemStat.index + '].fileName'}"
                                           th:value="${element.fileName}"/>
                                    <input type="hidden" th:id="${'elementFileLink-' + itemStat.index}"
                                           th:name="${'descriptionElementTos[' + itemStat.index + '].fileLink'}"
                                           th:value="${element.fileLink}"/>

                                    <div th:if="${element.type == T(ru.javaprojects.projector.projects.model.ElementType).TITLE ||
                                        element.type == T(ru.javaprojects.projector.projects.model.ElementType).PARAGRAPH}">
                                        <div class="form-floating">
                                            <div th:replace="~{:: element-actions-btn(addClass='position-absolute')}"></div>

                                            <textarea th:value="${element.text}"
                                                      th:name="${'descriptionElementTos[' + itemStat.index + '].text'}"
                                                      th:text="${element.text}"
                                                      th:id="${'elementText-' + itemStat.index}"
                                                      th:class="${#fields.hasErrors('descriptionElementTos[__${itemStat.index}__].text')} ?
                                                      'form-control lh-base is-invalid rounded-2' : 'form-control lh-base rounded-2'"
                                                      th:classappend="${element.type == T(ru.javaprojects.projector.projects.model.ElementType).TITLE ? 'fw-medium' : ''}"
                                                      placeholder="Title" style="white-space: pre-wrap;"
                                                      th:styleappend="${element.type == T(ru.javaprojects.projector.projects.model.ElementType).TITLE} ?
                                                      'height: 65px;' : 'height: 120px;'"
                                                      required></textarea>
                                            <label class="text-muted" th:text="${element.type}"></label>
                                        </div>
                                        <span th:if="${#fields.hasErrors('descriptionElementTos[__${itemStat.index}__].text')}">
                                            <ul>
                                                <li class="text-danger text-start"
                                                    th:each="err : ${#fields.errors('descriptionElementTos[__${itemStat.index}__].text')}"
                                                    th:text="${err}"/>
                                            </ul>
                                        </span>
                                    </div>

                                    <div class="border rounded-2 ps-3 pe-2 pb-1"
                                         th:if="${element.type == T(ru.javaprojects.projector.projects.model.ElementType).IMAGE}">
                                        <div th:replace="~{:: element-actions-btn(addClass='float-end')}"></div>

                                        <div class="text-start text-muted tiny" th:text="${element.type}">Type</div>
                                        <div class="d-flex align-items-start">
                                            <img th:if="${element.fileLink != null}" th:src="@{${'/' + element.fileLink}}"
                                                 height="150px" class="element-image rounded-2 mt-2 mb-1 border" style="cursor: zoom-in"
                                                 onclick="showLargerImage($(this))" />

                                            <input type="file" accept="image/*" th:id="${'elementImage-' + itemStat.index}"
                                                   th:name="${'descriptionElementTos[' + itemStat.index + '].imageFile'}"
                                                   hidden class="element-image-input" onchange="previewImage($(this))" />

                                            <img th:if="${element.imageFileString != null}"
                                                 th:src="@{'data:image/png;base64,'+${element.imageFileString}}"
                                                 height="150px" class="rounded-2 mt-2 mb-1 border"
                                                 style="cursor: zoom-in" onclick="showLargerImage($(this))" />

                                            <input type="hidden" th:id="${'elementImageString-' + itemStat.index}"
                                                   th:name="${'descriptionElementTos[' + itemStat.index + '].imageFileString'}"
                                                   th:value="${element.imageFileString}"/>

                                            <button type="button" class="change-img-btn btn btn-link opacity-75 link-underline-opacity-0 link-secondary pt-1"
                                                    title="Change image"
                                                    onclick="$(this).siblings('input').click()"><i class="fa-solid fa-pencil"></i>
                                            </button>

                                            <div class="empty-image-div border rounded-2 mt-2 mb-1 align-content-center text-center"
                                                 style="display: none; height: 150px; width: 300px;">
                                                <button type="button" class="btn btn-outline-secondary"
                                                        onclick="$(this).parent().siblings('input').click()">
                                                    Choose image
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Add new element button -->
                            <div>
                                <button  type="button" class="btn btn-sm btn-outline-success dropdown-toggle mt-1"
                                         data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa-solid fa-plus"></i> Add
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <button type="button" class="dropdown-item" onclick="addNewElement('Title')">
                                            Title
                                        </button>
                                    </li>
                                    <li>
                                        <button type="button" class="dropdown-item" onclick="addNewElement('Paragraph')">
                                            Paragraph
                                        </button>
                                    </li>
                                    <li>
                                        <button type="button" class="dropdown-item" onclick="addNewElement('Image')">
                                            Image
                                        </button>
                                    </li>
                                </ul>
                            </div>

                        </div>
                        <div class="card-footer text-end">
                            <button class="btn btn-secondary" type="button" onclick="cancel()">Cancel</button>
                            <button class="btn btn-primary ms-1" type="submit"
                                    th:text="${projectTo.isNew()} ? 'Create' : '&nbsp;&nbsp;Save&nbsp;&nbsp;'"
                                    onclick="checkImageElementsNotEmpty()">Create/Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Image modal -->
        <div class="modal fade" id="largerImageModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <img src="" id="largerImage" class="border" style="width: 100%;" />
                    </div>
                </div>
            </div>
        </div>
    </appMain>

    <!-- Element actions button fragment -->
    <div th:fragment="element-actions-btn">
        <button style="right: 10px;" type="button"
                class="btn btn-link link-secondary opacity-75 link-underline-opacity-0 p-0 dropdown-toggle"
                th:classappend="${addClass}"
                title="Edit" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa-solid fa-ellipsis-vertical"></i>
        </button>
        <ul class="dropdown-menu">
            <li>
                <button type="button" class="dropdown-item" onclick="moveElementUp(this)">
                    <i class="fa-solid fa-up-long text-warning"></i> Move up
                </button>
            </li>
            <li>
                <button type="button" class="dropdown-item" onclick="moveElementDown(this)">
                    <i class="fa-solid fa-down-long text-warning"></i> Move down
                </button>
            </li>
            <li>
                <button type="button" class="dropdown-item" onclick="deleteElement(this)">
                    <i class="fa-solid fa-xmark text-danger"></i> Delete
                </button>
            </li>
        </ul>
    </div>

    <ownScript>
        <script src="/js/cancel-button.js?v=1"></script>
        <script src="/js/bootstrap-selector-style.js?v=1"></script>
        <script src="/js/project-form.js?v=1"></script>
        <script src="/js/common.js?v=1"></script>

        <script>
            function showLargerImage(image) {
                $('#largerImage').attr('src', image.attr('src'));
                $('#largerImageModal').modal('show');
            }

            function previewImage(imageInput) {
                let files = imageInput.prop('files');
                if (files.length) {
                    let fileReader = new FileReader();
                    fileReader.onload = function (event) {
                        imageInput.siblings('img').attr('src', event.target.result).attr('hidden', false);
                        imageInput.siblings('.change-img-btn').attr('hidden', false);
                        imageInput.siblings('.empty-image-div').attr('style', 'display: none !important;');
                    }
                    fileReader.readAsDataURL(files[0]);
                } else {
                    imageInput.siblings('.empty-image-div').removeClass('bg-danger-subtle border-2 border-danger')
                        .attr('style', 'display: inline !important; height: 150px; width: 300px;');
                    imageInput.siblings('img').attr('hidden', true);
                    imageInput.siblings('.change-img-btn').attr('hidden', true);
                    imageInput.attr('required', true);
                }
            }

            function moveElementUp(moveUpBtn) {
                let elementContainer = $(moveUpBtn).closest('.element-container');
                let elementContainerId = elementContainer.attr('id');
                let elementContainerIndex = +elementContainerId.replace('elementContainer-', '');
                if (elementContainerIndex !== 0) {
                    let higherElementContainer = $(`#elementContainer-${elementContainerIndex - 1}`);
                    let higherElementContainerId = higherElementContainer.attr('id');
                    let higherElementContainerIndex = +higherElementContainerId.replace('elementContainer-', '');

                    swapElements(elementContainerIndex, higherElementContainerIndex);
                }
            }

            function moveElementDown(moveDownBtn) {
                let elementContainer = $(moveDownBtn).closest('.element-container');
                let elementContainerId = elementContainer.attr('id');
                let elementContainerIndex = +elementContainerId.replace('elementContainer-', '');
                let lowerElementContainer = $(`#elementContainer-${elementContainerIndex + 1}`);
                if (lowerElementContainer.length) {
                    let lowerElementContainerId = lowerElementContainer.attr('id');
                    let lowerElementContainerIndex = +lowerElementContainerId.replace('elementContainer-', '');

                    swapElements(elementContainerIndex, lowerElementContainerIndex);
                }
            }

            function swapElements(firstElemIndex, secondElemIndex) {
                let firstElementId = $(`#elementId-${firstElemIndex}`);
                let firstElementType = $(`#elementType-${firstElemIndex}`);
                let firstElementIndex = $(`#elementIndex-${firstElemIndex}`);
                let firstElementFileName = $(`#elementFileName-${firstElemIndex}`);
                let firstElementFileLink = $(`#elementFileLink-${firstElemIndex}`);
                let firstElementText = $(`#elementText-${firstElemIndex}`);
                let firstElementImage = $(`#elementImage-${firstElemIndex}`);
                let firstElementImageString = $(`#elementImageString-${firstElemIndex}`);

                let secondElementId = $(`#elementId-${secondElemIndex}`);
                let secondElementType = $(`#elementType-${secondElemIndex}`);
                let secondElementIndex = $(`#elementIndex-${secondElemIndex}`);
                let secondElementFileName = $(`#elementFileName-${secondElemIndex}`);
                let secondElementFileLink = $(`#elementFileLink-${secondElemIndex}`);
                let secondElementText = $(`#elementText-${secondElemIndex}`);
                let secondElementImage = $(`#elementImage-${secondElemIndex}`);
                let secondElementImageString = $(`#elementImageString-${secondElemIndex}`);

                firstElementId.attr('id', `elementId-${secondElemIndex}`).attr('name', `descriptionElementTos[${secondElemIndex}].id`);
                firstElementType.attr('id', `elementType-${secondElemIndex}`).attr('name', `descriptionElementTos[${secondElemIndex}].type`);
                firstElementIndex.attr('id', `elementIndex-${secondElemIndex}`).attr('name', `descriptionElementTos[${secondElemIndex}].index`);
                firstElementFileName.attr('id', `elementFileName-${secondElemIndex}`).attr('name', `descriptionElementTos[${secondElemIndex}].fileName`);
                firstElementFileLink.attr('id', `elementFileLink-${secondElemIndex}`).attr('name', `descriptionElementTos[${secondElemIndex}].fileLink`);
                if (firstElementText.length) {
                    firstElementText.attr('id', `elementText-${secondElemIndex}`).attr('name', `descriptionElementTos[${secondElemIndex}].text`);
                }
                if (firstElementImage.length) {
                    firstElementImage.attr('id', `elementImage-${secondElemIndex}`).attr('name', `descriptionElementTos[${secondElemIndex}].imageFile`);
                }
                if (firstElementImageString.length) {
                    firstElementImageString.attr('id', `elementImageString-${secondElemIndex}`).attr('name', `descriptionElementTos[${secondElemIndex}].imageFileString`);
                }

                secondElementId.attr('id', `elementId-${firstElemIndex}`).attr('name', `descriptionElementTos[${firstElemIndex}].id`);
                secondElementType.attr('id', `elementType-${firstElemIndex}`).attr('name', `descriptionElementTos[${firstElemIndex}].type`);
                secondElementIndex.attr('id', `elementIndex-${firstElemIndex}`).attr('name', `descriptionElementTos[${firstElemIndex}].index`);
                secondElementFileName.attr('id', `elementFileName-${firstElemIndex}`).attr('name', `descriptionElementTos[${firstElemIndex}].fileName`);
                secondElementFileLink.attr('id', `elementFileLink-${firstElemIndex}`).attr('name', `descriptionElementTos[${firstElemIndex}].fileLink`);
                if (secondElementText.length) {
                    secondElementText.attr('id', `elementText-${firstElemIndex}`).attr('name', `descriptionElementTos[${firstElemIndex}].text`);
                }
                if (secondElementImage.length) {
                    secondElementImage.attr('id', `elementImage-${firstElemIndex}`).attr('name', `descriptionElementTos[${firstElemIndex}].imageFile`);
                }
                if (secondElementImageString.length) {
                    secondElementImageString.attr('id', `elementImageString-${firstElemIndex}`).attr('name', `descriptionElementTos[${firstElemIndex}].imageFileString`);
                }

                let firstElementIndexValue = firstElementIndex.val();
                firstElementIndex.val(secondElementIndex.val());
                secondElementIndex.val(firstElementIndexValue);

                let firstElementContainer = $(`#elementContainer-${firstElemIndex}`);
                let secondElementContainer = $(`#elementContainer-${secondElemIndex}`);
                if (firstElemIndex > secondElemIndex) {
                    firstElementContainer.insertBefore(secondElementContainer);
                } else {
                    firstElementContainer.insertAfter(secondElementContainer);
                }
                firstElementContainer.attr('id', `elementContainer-${secondElemIndex}`);
                secondElementContainer.attr('id', `elementContainer-${firstElemIndex}`);
            }

            function deleteElement(deleteElementBtn) {
                let elementContainer = $(deleteElementBtn).closest('.element-container');
                let elementContainerId = elementContainer.attr('id');
                let elementContainerIndex = +elementContainerId.replace('elementContainer-', '');

                let elementIndexValue = $(`#elementIndex-${elementContainerIndex}`).val();
                let elementContainerAmount = $('.element-container').length;
                elementContainer.remove();
                for (let i = elementContainerIndex + 1; i < elementContainerAmount; i++) {
                    let lowerElementContainer = $(`#elementContainer-${i}`);
                    if (lowerElementContainer.length) {
                        let lowerElementId = $(`#elementId-${i}`);
                        let lowerElementType = $(`#elementType-${i}`);
                        let lowerElementIndex = $(`#elementIndex-${i}`);
                        let lowerElementFileName = $(`#elementFileName-${i}`);
                        let lowerElementFileLink = $(`#elementFileLink-${i}`);
                        let lowerElementText = $(`#elementText-${i}`);
                        let lowerElementImage = $(`#elementImage-${i}`);
                        let lowerElementImageString = $(`#elementImageString-${i}`);

                        lowerElementId.attr('id', `elementId-${i - 1}`).attr('name', `descriptionElementTos[${i - 1}].id`);
                        lowerElementType.attr('id', `elementType-${i - 1}`).attr('name', `descriptionElementTos[${i - 1}].type`);
                        lowerElementIndex.attr('id', `elementIndex-${i - 1}`).attr('name', `descriptionElementTos[${i - 1}].index`);
                        lowerElementFileName.attr('id', `elementFileName-${i - 1}`).attr('name', `descriptionElementTos[${i - 1}].fileName`);
                        lowerElementFileLink.attr('id', `elementFileLink-${i - 1}`).attr('name', `descriptionElementTos[${i - 1}].fileLink`);
                        if (lowerElementText.length) {
                            lowerElementText.attr('id', `elementText-${i - 1}`).attr('name', `descriptionElementTos[${i - 1}].text`);
                        }
                        if (lowerElementImage.length) {
                            lowerElementImage.attr('id', `elementImage-${i - 1}`).attr('name', `descriptionElementTos[${i - 1}].imageFile`);
                        }
                        if (lowerElementImageString.length) {
                            lowerElementImageString.attr('id', `elementImageString-${i - 1}`).attr('name', `descriptionElementTos[${i - 1}].imageFileString`);
                        }

                        let lowerElementIndexValue = lowerElementIndex.val();
                        lowerElementIndex.val(elementIndexValue);
                        elementIndexValue = lowerElementIndexValue;

                        lowerElementContainer.attr('id', `elementContainer-${i - 1}`);
                    }
                }
            }

            function addNewElement(type) {
                let newElementContainerIndex = $('.element-container').length;
                let newElementContainer = $('<div></div>').attr('id', `elementContainer-${newElementContainerIndex}`)
                    .addClass('element-container mb-1');

                let newElementType = $('<input type="hidden"/>').attr('id', `elementType-${newElementContainerIndex}`)
                    .attr('name', `descriptionElementTos[${newElementContainerIndex}].type`).val(type.toUpperCase());
                let newElementIndex = $('<input type="hidden"/>').attr('id', `elementIndex-${newElementContainerIndex}`)
                    .attr('name', `descriptionElementTos[${newElementContainerIndex}].index`)
                    .val(+($(`#elementIndex-${newElementContainerIndex - 1}`).val()) + 1);

                let newElementInputContentDiv = $('<div></div>');

                if (type === 'Title' || type === 'Paragraph') {
                    let formDiv = $('<div></div>').addClass('form-floating');
                    let newElementText = $('<textarea></textarea>').attr('id', `elementText-${newElementContainerIndex}`)
                        .attr('name', `descriptionElementTos[${newElementContainerIndex}].text`).attr('required', true)
                        .attr('placeholder', `${type}`).addClass('form-control lh-base')
                        .addClass(`${type === 'Title' ? 'fw-medium' : ''}`)
                        .css('white-space', 'pre-wrap').css('height', `${type === 'Title' ? '65px' : '120px'}`);
                    let label = $('<label></label>').addClass('text-muted').html(type);
                    formDiv.append(getElementActionsBtnHtml(type));
                    formDiv.append(newElementText);
                    formDiv.append(label);
                    newElementInputContentDiv.append(formDiv);

                } else if (type === 'Image') {
                    newElementInputContentDiv.addClass('border rounded-2 ps-3 pe-2 pb-1');

                    let label = $('<div></div>').addClass('text-start text-muted tiny').html(type);

                    let flexDiv = $('<div></div>').addClass('d-flex align-items-start');

                    let inputtedImage = $('<img />').addClass('element-image rounded-2 mt-2 mb-1 border')
                        .attr('hidden', true).css('height', '150px').css('cursor', 'zoom-in')
                        .click(function () {showLargerImage($(this))});

                    let imageInput = $('<input type="file"/>').attr('accept', 'image/*')
                        .attr('id', `elementImage-${newElementContainerIndex}`).attr('required', true)
                        .attr('name', `descriptionElementTos[${newElementContainerIndex}].imageFile`)
                        .attr('hidden', true).addClass('element-image-input').change(function () {previewImage($(this))});

                    let changeImageBtn = $('<button></button>').attr('type', 'button').attr('title', 'Change image')
                        .attr('hidden', true)
                        .addClass('change-img-btn btn btn-link opacity-75 link-underline-opacity-0 link-secondary pt-1')
                        .html(`<i class="fa-solid fa-pencil"></i>`).click(function () {$(this).siblings('input').click()});

                    let emptyImageDiv = $('<div></div>')
                        .addClass('empty-image-div border rounded-2 mt-2 mb-1 align-content-center text-center')
                        .css('height', '150px').css('width', '300px');

                    let chooseImageBtn = $('<button></button>').attr('type', 'button')
                        .addClass('btn btn-outline-secondary').html('Choose image')
                        .click(function () {$(this).parent().siblings('input').click()});

                    emptyImageDiv.append(chooseImageBtn);

                    flexDiv.append(inputtedImage).append(imageInput).append(changeImageBtn).append(emptyImageDiv);

                    newElementInputContentDiv.append(getElementActionsBtnHtml(type)).append(label).append(flexDiv);
                }

                newElementContainer.append(newElementType);
                newElementContainer.append(newElementIndex);
                newElementContainer.append(newElementInputContentDiv);

                $('#elementsBlock').append(newElementContainer);
            }

            function getElementActionsBtnHtml(type) {
                return `<button type="button"
                          class="${type !== 'Image' ? 'position-absolute' : ''}
                          float-end btn btn-link link-secondary opacity-75 link-underline-opacity-0 p-0 dropdown-toggle"
                          title="Edit" data-bs-toggle="dropdown" aria-expanded="false" style="right: 10px;">
                          <i class="fa-solid fa-ellipsis-vertical"></i>
                        </button>
                        <ul class="dropdown-menu">
                          <li>
                            <button type="button" class="dropdown-item" onclick="moveElementUp(this)">
                               <i class="fa-solid fa-up-long text-warning"></i> Move up
                            </button>
                          </li>
                          <li>
                             <button type="button" class="dropdown-item" onclick="moveElementDown(this)">
                                <i class="fa-solid fa-down-long text-warning"></i> Move down
                             </button>
                          </li>
                          <li>
                             <button type="button" class="dropdown-item" onclick="deleteElement(this)">
                                <i class="fa-solid fa-xmark text-danger"></i> Delete
                             </button>
                          </li>
                        </ul>`
            }

            function checkImageElementsNotEmpty() {
                $('.element-image-input').each(function() {
                    if ($(this).attr('required') && !$(this).val().length) {
                        console.log($(this).siblings('.empty-image-div'));
                        $(this).siblings('.empty-image-div').addClass('bg-danger-subtle border-2 border-danger');
                        failToast('You have empty image elements');
                    }

                })
            }


        </script>
    </ownScript>
</th:block>
