<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<!--/*@thymesVar id="projectTo" type="ru.javaprojects.projector.projects.ProjectTo"*/-->

<th:block th:replace="~{fragments/main::page(title='Projects',appMain=~{::appMain}, ownScript=~{::ownScript}, activeMenuItem=${ {'projects', 'management'} })}">
    <appMain>
        <div class="bg-info-subtle px-2 rounded-2 mb-10px border border-secondary-subtle py-0">
            <div class="row align-items-center" style="height: 46px">
                <div class="col text-start text-truncate">
                    <span class="h3 text-secondary font-weight-bold"
                          th:utext="${'<i class=''fa-solid fa-layer-group me-2''></i>Projects / ' + (projectTo.isNew() ? 'Create' : 'Edit')}">Projects / Create Edit</span>
                </div>
            </div>
        </div>

        <!-- Create/Edit project card -->
        <div class="row d-flex justify-content-center align-items-center">
            <div class="col-12 col-xxl-10">
                <div class="card shadow">
                    <div class="card-header">
                        <h3 class="text-center" th:text="${projectTo.isNew()} ? 'New project' : 'Edit: ' + ${projectTo.name}">Create/Edit project</h3>
                    </div>
                    <form th:action="@{/projects}" method="post" th:object="${projectTo}" enctype="multipart/form-data">
                        <div class="card-body text-start">
                            <input type="hidden" th:field="*{id}">
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text project-card-label">Name</span>
                                    <input type="text" id="nameInput" th:field="*{name}"
                                           th:class="${#fields.hasErrors('name')} ? 'form-control is-invalid' : 'form-control'"
                                           required placeholder="Name" />
                                </div>
                                <span th:if="${#fields.hasErrors('name')}">
                                    <ul>
                                        <li class="text-danger text-start" th:each="err : ${#fields.errors('name')}"
                                            th:text="${err}"/>
                                    </ul>
                                </span>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text project-card-label">Architecture</span>
                                        <select class="form-control selectpicker border" data-style="btn-white"
                                                name="architecture" title="Architecture" required>
                                            <option th:each="architecture : ${architectures}"
                                                    th:value="${architecture.id}"
                                                    th:text="${architecture.name}"
                                                    th:selected="${projectTo.architecture != null && projectTo.architecture.id == architecture.id}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text project-card-label">Dev start date</span>
                                        <input type="date" id="startDate" name="startDate" th:value="${projectTo.startDate}"
                                               class="form-control date-input" th:classappend="${projectTo.startDate == null ? 'text-muted' : ''}" required />
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text project-card-label">Dev end date</span>
                                        <input type="date" name="endDate" th:value="${projectTo.endDate}"
                                               class="form-control date-input" th:classappend="${projectTo.endDate == null ? 'text-muted' : ''}" required />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text project-card-label">Priority</span>
                                        <select class="form-control selectpicker border" data-style="btn-white"
                                                th:field="*{priority}" title="Priority" required>
                                            <option th:each="priority : ${priorities}"
                                                    th:value="${priority.name}"
                                                    th:text="${priority}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text project-card-label">Visibility</span>
                                        <span class="form-control">
                                            <div class="form-switch">
                                                <input type="checkbox" role="switch" th:field="*{enabled}" class="form-check-input me-1"
                                                       style="cursor: pointer;" id="visibilityCheckbox" />
                                                <span th:text="${projectTo.enabled ? 'Visible to users' : 'Not visible to users'}" id="visibilityCheckboxDesc"></span>
                                            </div>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <div th:hidden="${logoFile == null}" class="input-group" id="logoFilePreviewDiv">
                                        <span class="input-group-text project-card-label">Logo file</span>
                                        <div class="form-control py-1 text-start">
                                            <img th:src="@{${logoFile != null ? ('/' + logoFile.fileLink) : ''}}"
                                                 width="24" height="24" id="logoFilePreview"/>
                                            <span th:text="${logoFile?.fileName}" id="logoFileName">File name</span>
                                            <a tabindex="0" type="button" class="float-end text-danger" title="Delete"
                                               onclick="deleteLogoFile()">
                                                <i class="fa-solid fa-xmark"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div id="logoFileInputDiv">
                                        <div th:if="${logoFile == null}" class="input-group custom-file-button">
                                            <label class="input-group-text bg-light project-card-label">Logo file</label>
                                            <input type="file" accept="image/*" th:field="*{logoFile}" class="form-control text-muted"
                                                   id="logoFileInput" required onchange="previewLogoFile()"/>
                                        </div>
                                        <span th:if="${#fields.hasErrors('logoFile')}">
                                            <ul>
                                                <li class="text-danger text-start"
                                                    th:each="err : ${#fields.errors('logoFile')}" th:text="${err}"/>
                                            </ul>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <div th:hidden="${dockerComposeFile == null}" class="input-group" id="dockerFilePreviewDiv">
                                        <span class="input-group-text project-card-label">Docker file</span>
                                        <div class="form-control py-1 text-start">
                                            <a th:href="@{${'/' + dockerComposeFile?.fileLink}}" id="dockerComposeFileRef"
                                               th:utext="'<i class=&quot;text-primary me-1 fa-brands fa-docker&quot;></i>' + ${dockerComposeFile?.fileName}"
                                               target="_blank" title="Download file">File name</a>

                                            <a tabindex="0" type="button" class="float-end text-danger" title="Delete"
                                               onclick="deleteDockerFile()">
                                                <i class="fa-solid fa-xmark"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div id="dockerFileInputDiv">
                                        <div th:if="${dockerComposeFile == null}" class="input-group custom-file-button">
                                            <label class="input-group-text bg-light project-card-label">Docker file</label>
                                            <input type="file" accept=".yaml,.yml" th:field="*{dockerComposeFile}" class="form-control text-muted"
                                                   id="dockerFileInput" onchange="previewDockerFile()"/>
                                        </div>
                                        <span th:if="${#fields.hasErrors('dockerComposeFile')}">
                                            <ul>
                                                <li class="text-danger text-start"
                                                    th:each="err : ${#fields.errors('dockerComposeFile')}" th:text="${err}"/>
                                            </ul>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3 align-items-center">
                                <div class="col-11">
                                    <div class="input-group">
                                        <span class="input-group-text project-card-label">Deployment URL</span>
                                        <input type="url" id="deploymentUrlInput" th:field="*{deploymentUrl}" class="url"
                                               th:classappend="${#fields.hasErrors('deploymentUrl')} ? 'form-control is-invalid' : 'form-control'"
                                               placeholder="Deployment URL" />
                                    </div>
                                    <span th:if="${#fields.hasErrors('deploymentUrl')}">
                                        <ul>
                                            <li class="text-danger text-start" th:each="err : ${#fields.errors('deploymentUrl')}"
                                                th:text="${err}"/>
                                        </ul>
                                    </span>
                                </div>
                                <div class="col-1">
                                    <a th:hidden="${projectTo.deploymentUrl == null}" th:href="${projectTo.deploymentUrl}" class="url-check"
                                       title="Check deployment URL" id="deploymentUrlCheck" target="_blank"><i class="fa-solid fa-up-right-from-square ms-1"></i></a>
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <div class="col-11">
                                    <div class="input-group">
                                        <span class="input-group-text project-card-label">Open API URL</span>
                                        <input type="url" id="openApiUrlInput" th:field="*{openApiUrl}" class="url"
                                               th:classappend="${#fields.hasErrors('openApiUrl')} ? 'form-control is-invalid' : 'form-control'"
                                               placeholder="Open API URL" />
                                    </div>
                                    <span th:if="${#fields.hasErrors('openApiUrl')}">
                                        <ul>
                                            <li class="text-danger text-start" th:each="err : ${#fields.errors('openApiUrl')}"
                                                th:text="${err}"/>
                                        </ul>
                                    </span>
                                </div>
                                <div class="col-1">
                                    <a th:hidden="${projectTo.openApiUrl == null}" th:href="${projectTo.openApiUrl}" class="url-check"
                                       title="Check Open API URL" id="openApiUrlCheck" target="_blank"><i class="fa-solid fa-up-right-from-square ms-1"></i></a>
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <div class="col-11">
                                    <div class="input-group">
                                        <span class="input-group-text project-card-label">Backend src URL</span>
                                        <input type="url" id="backendSrcUrlInput" th:field="*{backendSrcUrl}" class="url"
                                               th:classappend="${#fields.hasErrors('backendSrcUrl')} ? 'form-control is-invalid' : 'form-control'"
                                               required placeholder="Backend src URL" />
                                    </div>
                                    <span th:if="${#fields.hasErrors('backendSrcUrl')}">
                                        <ul>
                                            <li class="text-danger text-start" th:each="err : ${#fields.errors('backendSrcUrl')}"
                                                th:text="${err}"/>
                                        </ul>
                                    </span>
                                </div>
                                <div class="col-1">
                                    <a th:hidden="${projectTo.backendSrcUrl == null}" th:href="${projectTo.backendSrcUrl}" class="url-check"
                                       title="Check backend src URL" id="backendSrcUrlCheck" target="_blank"><i class="fa-solid fa-up-right-from-square ms-1"></i></a>
                                </div>
                            </div>
                            <div class="row mb-3 align-items-center">
                                <div class="col-11">
                                    <div class="input-group">
                                        <span class="input-group-text project-card-label">Frontend src URL</span>
                                        <input type="url" id="frontendSrcUrlInput" th:field="*{frontendSrcUrl}" class="url"
                                               th:classappend="${#fields.hasErrors('frontendSrcUrl')} ? 'form-control is-invalid' : 'form-control'"
                                               placeholder="Frontend src URL" />
                                    </div>
                                    <span th:if="${#fields.hasErrors('frontendSrcUrl')}">
                                        <ul>
                                            <li class="text-danger text-start" th:each="err : ${#fields.errors('frontendSrcUrl')}"
                                                th:text="${err}"/>
                                        </ul>
                                    </span>
                                </div>
                                <div class="col-1">
                                    <a th:hidden="${projectTo.frontendSrcUrl == null}" th:href="${projectTo.frontendSrcUrl}" class="url-check"
                                       title="Check frontend src URL" id="frontendSrcUrlCheck" target="_blank"><i class="fa-solid fa-up-right-from-square ms-1"></i></a>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <div th:hidden="${cardImageFile == null}" class="input-group" id="cardImageFilePreviewDiv">
                                        <span class="input-group-text project-card-label">Card image file</span>
                                        <div class="form-control py-1 text-start">
                                            <img th:src="@{${cardImageFile != null ? ('/' + cardImageFile.fileLink) : ''}}"
                                                 width="42" height="24" id="cardImageFilePreview"/>
                                            <span th:text="${cardImageFile?.fileName}" id="cardImageFileName">File name</span>
                                            <a tabindex="0" type="button" class="float-end text-danger" title="Delete"
                                               onclick="deleteCardImageFile()">
                                                <i class="fa-solid fa-xmark"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div id="cardImageFileInputDiv">
                                        <div th:if="${cardImageFile == null}" class="input-group custom-file-button">
                                            <label class="input-group-text bg-light project-card-label">Card image file</label>
                                            <input type="file" accept="image/*" th:field="*{cardImageFile}" class="form-control text-muted"
                                                   id="cardImageFileInput" required onchange="previewCardImageFile()"/>
                                        </div>
                                        <span th:if="${#fields.hasErrors('cardImageFile')}">
                                            <ul>
                                                <li class="text-danger text-start"
                                                    th:each="err : ${#fields.errors('cardImageFile')}" th:text="${err}"/>
                                            </ul>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text project-card-label">Technologies</span>
                                        <select class="form-control selectpicker border" data-style="btn-white" id="technologiesSelector"
                                                name="technologies" multiple data-selected-text-format="count > 3" title="Technologies" required>
                                            <option th:each="technology : ${technologies}"
                                                    th:value="${technology.id}"
                                                    th:text="${technology.name}"
                                                    th:data-name="${technology.name}"
                                                    th:data-filelink="${technology.logoFile.fileLink}"
                                                    th:selected="${projectTo.technologies != null && projectTo.technologies.contains(technology)}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-4 mb-3">
                                    <div class="border rounded-2 px-3 pb-3 text-center h-100">
                                        <div class="text-start text-muted">
                                            Card image
                                        </div>
                                        <img th:src="@{${cardImageFile != null ? ('/' + cardImageFile.fileLink) : ''}}"
                                             height="150px" class="rounded-2 mt-2" id="cardImageFileLargePreview"/>
                                    </div>
                                </div>
                                <div class="col-lg-8 mb-3">
                                    <div class="border rounded-2 px-3 pb-3 h-100">
                                        <div class="text-start text-muted">
                                            Technologies
                                        </div>
                                        <div id="technologiesPreviewDiv">
                                            <span th:each="technology : ${projectTo.technologies}" class="badge text-bg-light me-2 mt-2" th:id="${'techSpan-' + technology.id}">
                                                <img th:src="@{${technology.logoFile != null ? ('/' + technology.logoFile.fileLink) : ''}}"
                                                     width="32" height="32" th:text="${technology.name}" class="align-bottom"/>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-floating">
                                    <textarea id="shortDescriptionInput" th:field="*{shortDescription}"
                                              th:class="${#fields.hasErrors('shortDescription')} ? 'form-control lh-base is-invalid' : 'form-control lh-base'"
                                              placeholder="Short description" style="height: 90px; white-space: pre-wrap;"
                                              maxlength="128" required></textarea>
                                    <label for="shortDescriptionInput" class="text-muted">Short description</label>
                                </div>
                                <small class="float-end text-muted" id="characterCounter"
                                       th:text="*{(128 - (shortDescription == null ? 0 : shortDescription.length())) + ' characters left'}">Characters left</small>
                                <span th:if="${#fields.hasErrors('shortDescription')}">
                                    <ul>
                                        <li class="text-danger text-start" th:each="err : ${#fields.errors('shortDescription')}"
                                            th:text="${err}"/>
                                    </ul>
                                </span>
                            </div>

                        </div>
                        <div class="card-footer text-end">
                            <button class="btn btn-secondary" type="button" onclick="cancel()">Cancel</button>
                            <button class="btn btn-primary ms-1" type="submit"
                                    th:text="${projectTo.isNew()} ? 'Create' : '&nbsp;&nbsp;Save&nbsp;&nbsp;'">Create/Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </appMain>

    <ownScript>
        <script src="/js/cancel-button.js?v=1"></script>
        <script src="/js/bootstrap-selector-style.js?v=1"></script>
        <script src="/js/project-form.js?v=1"></script>
    </ownScript>
</th:block>
